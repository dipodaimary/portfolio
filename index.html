<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MCQ Quiz</title>
  <style>
    :root{ --accent:#2b7cff; --bg:#f6f8fb; --card:#fff; --muted:#666 }
    *{box-sizing:border-box}
    body{font-family:Inter,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:var(--bg);color:#111}
    .app{display:grid;grid-template-columns:260px 1fr;min-height:100vh}
    .sidebar{padding:18px;background:#fff;border-right:1px solid #e6e9ef}
    .logo{font-weight:700;color:var(--accent);margin-bottom:12px}
    .file-list{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:8px;max-height:70vh;overflow:auto}
    .file-item{padding:10px;border-radius:8px;border:1px solid #eef2f7;cursor:pointer;background:#fff}
    .file-item:hover{box-shadow:0 2px 8px rgba(36,55,98,0.06)}
    .file-item.active{background:linear-gradient(90deg,rgba(43,124,255,0.08),#fff);border-color:var(--accent)}
    .main{padding:24px}
    .card{background:var(--card);padding:20px;border-radius:10px;box-shadow:0 6px 18px rgba(32,40,60,0.04)}
    .meta{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
    .progress{font-size:14px;color:var(--muted)}
    h2{margin:0 0 12px 0}
    .question-text{font-size:18px;margin-bottom:12px}
    .options{display:flex;flex-direction:column;gap:8px}
    .option{padding:10px;border-radius:8px;border:1px solid #eef2f7;cursor:pointer;display:flex;gap:12px;align-items:center}
    .option input{margin:0}
    .controls{display:flex;gap:8px;margin-top:14px}
    button{cursor:pointer;padding:8px 12px;border-radius:8px;border:0;background:var(--accent);color:#fff}
    button.ghost{background:#fff;color:var(--accent);border:1px solid #e6e9ef}
    button:disabled{opacity:0.5;cursor:not-allowed}
    .explanation{margin-top:12px;padding:12px;border-radius:8px;border:1px dashed #e6edf9;background:#fcfeff}
    .correct{background:#dff7dc;border-color:#b7e2b0}
    .wrong{background:#ffe7e6;border-color:#ffbfbd}
    .center{display:flex;align-items:center;justify-content:center;height:100%}
    @media(max-width:780px){.app{grid-template-columns:1fr} .sidebar{order:2}}
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar card">
      <div class="logo">MCQ Quiz</div>
      <ul id="fileList" class="file-list"></ul>
    </aside>

    <main class="main">
      <div id="mainCard" class="card center">
        <div style="max-width:900px;width:100%">
          <div id="empty" class="center" style="flex-direction:column;min-height:220px">
            <div style="font-weight:600;font-size:18px;margin-bottom:8px">Select a question file to start</div>
          </div>

          <div id="quizArea" style="display:none">
            <div class="meta">
              <div>
                <div id="fileTitle" style="font-weight:600"></div>
                <div class="progress" id="qProgress"></div>
              </div>
              <div>
                <button id="restartBtn" class="ghost">Restart</button>
              </div>
            </div>

            <div id="questionCard" class="card">
              <h2 id="qTitle">Question</h2>
              <div class="question-text" id="qText"></div>
              <div id="options" class="options"></div>

              <div class="controls">
                <button id="prevBtn" class="ghost">Previous</button>
                <button id="nextBtn" class="ghost">Next</button>
                <div style="flex:1"></div>
                <button id="showAnsBtn">Show Answer</button>
              </div>

              <div id="explain" style="display:none" class="explanation"></div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

<script>
(async function(){
  // Embedded fallback list (your provided filenames)
  const EMBEDDED_FILES = [
    "decisiontree.json",
    "embeddings.json",
    "intro_ml.json",
    "optimization.json",
    "dnn_cv.json",
    "ensemble.json",
    "knn.json",
    "stat_decision_theory.json",
    "dnn_intro.json",
    "expect_max.json",
    "linearreg.json",
    "svm.json",
    "dnn_nlp.json",
    "generalization.json",
    "logreg.json",
    "dual_kernels.json",
    "graphical_models.json",
    "misc.json"
  ];

  const state = { files: [], questions: [], current: 0, revealed: false, filename: '' };

  // DOM refs
  const fileListEl = document.getElementById('fileList');
  const emptyEl = document.getElementById('empty');
  const quizArea = document.getElementById('quizArea');
  const fileTitle = document.getElementById('fileTitle');
  const qProgress = document.getElementById('qProgress');
  const qTitle = document.getElementById('qTitle');
  const qText = document.getElementById('qText');
  const optionsEl = document.getElementById('options');
  const explainEl = document.getElementById('explain');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const showAnsBtn = document.getElementById('showAnsBtn');
  const restartBtn = document.getElementById('restartBtn');

  function setLoadingFiles(names){
    fileListEl.innerHTML = '';
    names.forEach(n=>{
      const li = document.createElement('li');
      li.className = 'file-item';
      li.textContent = n;
      li.onclick = ()=> selectFile(n, li);
      fileListEl.appendChild(li);
    });
  }

  // robust unique id
  function uniqueId() {
    try {
      if (typeof crypto !== 'undefined' && crypto.getRandomValues) {
        return crypto.getRandomValues(new Uint32Array(1))[0].toString(36);
      }
    } catch(e) {}
    return Date.now().toString(36) + '_' + Math.floor(Math.random()*1e6).toString(36);
  }

  // fetch helpers
  async function fetchJsonArray(url){
    try{
      const res = await fetch(url, {cache: 'no-store'});
      if(!res.ok) throw new Error(`${url} returned ${res.status}`);
      const ct = (res.headers.get('content-type')||'').toLowerCase();
      if(!ct.includes('application/json') && !ct.includes('text/json')) {
        const body = await res.text();
        throw new Error(`${url} returned content-type ${ct || 'unknown'}. Preview: ${body.slice(0,200)}`);
      }
      const j = await res.json();
      return Array.isArray(j) ? j : null;
    }catch(err){
      return null;
    }
  }

  async function parseDirectoryListingHTML(dirUrl){
    try{
      const res = await fetch(dirUrl, {cache: 'no-store'});
      if(!res.ok) throw new Error('no listing');
      const ct = (res.headers.get('content-type')||'').toLowerCase();
      if(!ct.includes('text/html')) return null;
      const text = await res.text();
      const parser = new DOMParser();
      const doc = parser.parseFromString(text, 'text/html');
      const anchors = Array.from(doc.querySelectorAll('a[href]'));
      const files = [];
      for(const a of anchors){
        let href = a.getAttribute('href');
        if(!href) continue;
        if(href === '../' || href === '/') continue;
        href = href.split('?')[0].split('#')[0];
        if(href.toLowerCase().endsWith('.json')){
          const parts = href.split('/');
          const name = parts[parts.length-1];
          if(name) files.push(name);
        }
      }
      return [...new Set(files)].sort();
    }catch(err){
      return null;
    }
  }

  // init attempts: endpoint -> index.json -> directory HTML -> embedded
  async function initFileList(){
    let files = await fetchJsonArray('/questions/list');
    if(Array.isArray(files) && files.length){ state.files = files; setLoadingFiles(files); return; }

    files = await fetchJsonArray('/questions/index.json');
    if(Array.isArray(files) && files.length){ state.files = files; setLoadingFiles(files); return; }

    const parsed = await parseDirectoryListingHTML('/questions/');
    if(Array.isArray(parsed) && parsed.length){ state.files = parsed; setLoadingFiles(parsed); return; }

    // fallback to embedded
    state.files = EMBEDDED_FILES.slice();
    setLoadingFiles(state.files);
  }

  // load file and parse JSON; improved error messages
  async function selectFile(filename, liEl){
    Array.from(fileListEl.children).forEach(ch=>ch.classList.remove('active'));
    if(liEl) liEl.classList.add('active');

    try{
      const res = await fetch('/questions/'+filename, {cache: 'no-store'});
      if(!res.ok) throw new Error(`Server responded ${res.status} for /questions/${filename}`);
      const bodyText = await res.text();
      let data;
      try { data = JSON.parse(bodyText); }
      catch(parseErr) {
        throw new Error(`Failed to parse JSON for /questions/${filename}. Response preview: ${bodyText.slice(0,400)}`);
      }

      let questions = Array.isArray(data) ? data : (data.questions || []);
      if(!questions || questions.length===0){ alert('No questions found in '+filename); return; }

      state.questions = questions;
      state.current = 0;
      state.revealed = false;
      state.filename = filename;
      fileTitle.textContent = filename;
      emptyEl.style.display = 'none';
      quizArea.style.display = 'block';
      renderQuestion();
    }catch(err){
      alert('Error loading file: ' + err.message + '\nTip: verify the file exists at /questions/' + filename + ' and that it is valid JSON.');
    }
  }

  function renderQuestion(){
    const q = state.questions[state.current];
    qTitle.textContent = `Q${state.current+1}: ${q.id ? '(id '+q.id+')' : ''}`;
    qText.textContent = q.question || 'Question text missing';

    const isMultiple = Array.isArray(q.correct);
    optionsEl.innerHTML = '';

    const uid = uniqueId();
    const name = 'opt_' + uid + '_' + state.current;

    (q.options || []).forEach((opt, idx)=>{
      const optEl = document.createElement('label');
      optEl.className = 'option';
      optEl.dataset.idx = idx;

      const input = document.createElement('input');
      input.type = isMultiple ? 'checkbox' : 'radio';
      input.name = name;
      input.value = idx;

      const txt = document.createElement('span');
      txt.textContent = opt;

      optEl.appendChild(input);
      optEl.appendChild(txt);
      optionsEl.appendChild(optEl);
    });

    qProgress.textContent = `${state.current+1} / ${state.questions.length}`;
    explainEl.style.display = 'none';
    explainEl.innerHTML = '';
    prevBtn.disabled = state.current === 0;
    nextBtn.disabled = state.current === state.questions.length-1;
    state.revealed = false;
    showAnsBtn.disabled = false;
  }

  function revealAnswer(){
    const q = state.questions[state.current];
    const isMultiple = Array.isArray(q.correct);
    const correctIdxs = isMultiple ? q.correct : [q.correct];

    Array.from(optionsEl.children).forEach(label=>{
      const idx = Number(label.dataset.idx);
      const input = label.querySelector('input');
      label.classList.remove('correct','wrong');
      if(correctIdxs.includes(idx)) label.classList.add('correct');
      else if(input.checked) label.classList.add('wrong');
    });

    explainEl.style.display = 'block';
    const explanation = q.explanation || 'No explanation provided.';
    const selected = Array.from(optionsEl.querySelectorAll('input')).map((inp,i)=> inp.checked ? i : -1).filter(i=>i>=0);

    let status = '';
    if(selected.length===0) status = '<div style="margin-bottom:6px;color:#555">You did not select an answer.</div>';
    else {
      const selSet = new Set(selected);
      const corrSet = new Set(correctIdxs);
      const equal = selSet.size===corrSet.size && [...selSet].every(x => corrSet.has(x));
      status = equal ? '<div style="margin-bottom:6px;color:green;font-weight:600">Your selection is CORRECT</div>' : '<div style="margin-bottom:6px;color:#b33;font-weight:600">Your selection is INCORRECT</div>';
    }

    explainEl.innerHTML = status + '<div><strong>Answer:</strong> ' + correctIdxs.map(i=> q.options[i]).join(', ') + '</div>'
      + '<div style="margin-top:8px"><strong>Explanation:</strong><div style="margin-top:6px">'+explanation+'</div></div>';

    state.revealed = true;
    showAnsBtn.disabled = true;
  }

  prevBtn.addEventListener('click', ()=>{ if(state.current>0){ state.current--; renderQuestion(); }});
  nextBtn.addEventListener('click', ()=>{ if(state.current < state.questions.length-1){ state.current++; renderQuestion(); }});
  showAnsBtn.addEventListener('click', ()=> revealAnswer());
  restartBtn.addEventListener('click', ()=> { if(state.filename) selectFile(state.filename); });

  await initFileList();

  const params = new URLSearchParams(location.search);
  if(params.has('file')) setTimeout(()=> selectFile(params.get('file')), 300);

})();
</script>
</body>
</html>
