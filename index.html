<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MCQ Quiz - Fixed</title>
  <style>
    :root{ --accent:#2b7cff; --bg:#f6f8fb; --card:#fff; --muted:#666 }
    *{box-sizing:border-box}
    body{font-family:Inter,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:var(--bg);color:#111}
    .app{display:grid;grid-template-columns:300px 1fr;min-height:100vh}
    .sidebar{padding:18px;background:#fff;border-right:1px solid #e6e9ef}
    .logo{font-weight:700;color:var(--accent);margin-bottom:12px}
    .file-list{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:8px;max-height:60vh;overflow:auto}
    .file-item{padding:10px;border-radius:8px;border:1px solid #eef2f7;cursor:pointer;background:#fff}
    .file-item:hover{box-shadow:0 2px 8px rgba(36,55,98,0.06)}
    .file-item.active{background:linear-gradient(90deg,rgba(43,124,255,0.08),#fff);border-color:var(--accent)}
    .main{padding:24px}
    .card{background:var(--card);padding:20px;border-radius:10px;box-shadow:0 6px 18px rgba(32,40,60,0.04)}
    .meta{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
    .progress{font-size:14px;color:var(--muted)}
    h2{margin:0 0 12px 0}
    .question-text{font-size:18px;margin-bottom:12px}
    .options{display:flex;flex-direction:column;gap:8px}
    .option{padding:10px;border-radius:8px;border:1px solid #eef2f7;cursor:pointer;display:flex;gap:12px;align-items:center}
    .option input{margin:0}
    .controls{display:flex;gap:8px;margin-top:14px}
    button{cursor:pointer;padding:8px 12px;border-radius:8px;border:0;background:var(--accent);color:#fff}
    button.ghost{background:#fff;color:var(--accent);border:1px solid #e6e9ef}
    button:disabled{opacity:0.5;cursor:not-allowed}
    .explanation{margin-top:12px;padding:12px;border-radius:8px;border:1px dashed #e6edf9;background:#fcfeff}
    .correct{background:#dff7dc;border-color:#b7e2b0}
    .wrong{background:#ffe7e6;border-color:#ffbfbd}
    .hint{font-size:13px;color:var(--muted)}
    .center{display:flex;align-items:center;justify-content:center;height:100%}
    @media(max-width:780px){.app{grid-template-columns:1fr} .sidebar{order:2}}
    pre.server-snippet{background:#f8f9fc;padding:8px;border-radius:6px;border:1px solid #eef2f7;white-space:pre-wrap;font-size:12px}
    .small{font-size:13px;color:var(--muted)}
    .download-btn{display:inline-block;margin-top:8px;padding:6px 10px;border-radius:6px;background:#f3f7ff;color:var(--accent);border:1px solid #dbe9ff;cursor:pointer}
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar card">
      <div class="logo">MCQ Quiz</div>
      <div class="small">This app attempts (in order): /questions/list, /questions/index.json, /questions/ directory listing, ?file=..., then embedded fallback.</div>
      <hr style="margin:8px 0 12px 0;border:none;border-top:1px solid #f0f3f7" />
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px">
        <button id="downloadIndex" class="ghost">Download index.json</button>
        <button id="useEmbedded" class="ghost">Use embedded list now</button>
      </div>
      <ul id="fileList" class="file-list"></ul>
      <div style="margin-top:12px;font-size:13px;color:var(--muted)">If server cannot be changed, download <code>index.json</code> and upload to <code>questions/</code>.</div>
    </aside>

    <main class="main">
      <div id="mainCard" class="card center">
        <div style="max-width:920px;width:100%">
          <div id="empty" class="center" style="flex-direction:column;min-height:220px">
            <div style="font-weight:600;font-size:18px;margin-bottom:8px">Select a question file to start the quiz</div>
            <div style="color:var(--muted)">Make sure your files are accessible at <code>/questions/*.json</code>.</div>
          </div>

          <div id="quizArea" style="display:none">
            <div class="meta">
              <div>
                <div id="fileTitle" style="font-weight:600"></div>
                <div class="progress" id="qProgress"></div>
              </div>
              <div>
                <button id="restartBtn" class="ghost">Restart</button>
              </div>
            </div>

            <div id="questionCard" class="card">
              <h2 id="qTitle">Question</h2>
              <div class="question-text" id="qText"></div>
              <div id="options" class="options"></div>

              <div class="controls">
                <button id="prevBtn" class="ghost">Previous</button>
                <button id="nextBtn" class="ghost">Next</button>
                <div style="flex:1"></div>
                <button id="showAnsBtn">Show Answer</button>
              </div>

              <div id="explain" style="display:none" class="explanation"></div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

<script>
(async function(){
  // embedded list you gave (fallback)
  const EMBEDDED_FILES = [
    "decisiontree.json",
    "embeddings.json",
    "intro_ml.json",
    "optimization.json",
    "dnn_cv.json",
    "ensemble.json",
    "knn.json",
    "stat_decision_theory.json",
    "dnn_intro.json",
    "expect_max.json",
    "linearreg.json",
    "svm.json",
    "dnn_nlp.json",
    "generalization.json",
    "logreg.json",
    "dual_kernels.json",
    "graphical_models.json",
    "misc.json"
  ];

  // state & dom
  const state = { files: [], questions: [], current: 0, revealed: false, filename: '' }
  const fileListEl = document.getElementById('fileList')
  const emptyEl = document.getElementById('empty')
  const quizArea = document.getElementById('quizArea')
  const fileTitle = document.getElementById('fileTitle')
  const qProgress = document.getElementById('qProgress')
  const qTitle = document.getElementById('qTitle')
  const qText = document.getElementById('qText')
  const optionsEl = document.getElementById('options')
  const explainEl = document.getElementById('explain')
  const prevBtn = document.getElementById('prevBtn')
  const nextBtn = document.getElementById('nextBtn')
  const showAnsBtn = document.getElementById('showAnsBtn')
  const restartBtn = document.getElementById('restartBtn')
  const downloadIndexBtn = document.getElementById('downloadIndex')
  const useEmbeddedBtn = document.getElementById('useEmbedded')

  function setLoadingFiles(names){
    fileListEl.innerHTML = ''
    names.forEach(n=>{
      const li = document.createElement('li')
      li.className = 'file-item'
      li.textContent = n
      li.onclick = ()=> selectFile(n, li)
      fileListEl.appendChild(li)
    })
  }

  // robust UID for input group names: prefer crypto
  function uniqueId() {
    try {
      if (typeof crypto !== 'undefined' && crypto.getRandomValues) {
        return crypto.getRandomValues(new Uint32Array(1))[0].toString(36);
      }
    } catch(e) { /* ignore */ }
    return Date.now().toString(36) + '_' + Math.floor(Math.random()*1e6).toString(36);
  }

  // fetch helpers
  async function fetchJsonArray(url){
    try{
      const res = await fetch(url, {cache: 'no-store'});
      if(!res.ok) throw new Error(`${url} returned ${res.status}`);
      const ct = (res.headers.get('content-type')||'').toLowerCase();
      if(!ct.includes('application/json') && !ct.includes('text/json')) {
        // try to parse anyway but inform user
        const body = await res.text();
        throw new Error(`${url} returned content-type ${ct || 'unknown'}; expected JSON. Response preview: ${body.slice(0,200)}`);
      }
      const j = await res.json();
      return Array.isArray(j) ? j : null;
    }catch(err){
      return null;
    }
  }

  async function parseDirectoryListingHTML(dirUrl){
    try{
      const res = await fetch(dirUrl, {cache: 'no-store'});
      if(!res.ok) throw new Error('no listing');
      const ct = (res.headers.get('content-type')||'').toLowerCase();
      if(!ct.includes('text/html')) return null;
      const text = await res.text();
      const parser = new DOMParser();
      const doc = parser.parseFromString(text, 'text/html');
      const anchors = Array.from(doc.querySelectorAll('a[href]'));
      const files = [];
      for(const a of anchors){
        let href = a.getAttribute('href');
        if(!href) continue;
        if(href === '../' || href === '/') continue;
        href = href.split('?')[0].split('#')[0];
        if(href.toLowerCase().endsWith('.json')){
          const parts = href.split('/');
          const name = parts[parts.length-1];
          if(name) files.push(name);
        }
      }
      return [...new Set(files)].sort();
    }catch(err){
      return null;
    }
  }

  // init: try several listing mechanisms
  async function initFileList(){
    // 1) /questions/list
    let files = await fetchJsonArray('/questions/list');
    if(Array.isArray(files) && files.length){
      state.files = files; setLoadingFiles(files); return;
    }

    // 2) /questions/index.json
    files = await fetchJsonArray('/questions/index.json');
    if(Array.isArray(files) && files.length){
      state.files = files; setLoadingFiles(files); return;
    }

    // 3) parse directory listing HTML at /questions/
    const parsed = await parseDirectoryListingHTML('/questions/');
    if(Array.isArray(parsed) && parsed.length){
      state.files = parsed; setLoadingFiles(parsed); return;
    }

    // 4) embedded fallback
    if(Array.isArray(EMBEDDED_FILES) && EMBEDDED_FILES.length){
      state.files = EMBEDDED_FILES.slice();
      setLoadingFiles(state.files);
      const note = document.createElement('li');
      note.style.opacity = 0.85; note.style.fontSize = '12px'; note.style.marginTop = '8px';
      note.innerHTML = 'Using embedded file list (client-side fallback). You can download <strong>index.json</strong> to install on the server.';
      fileListEl.appendChild(note);
      return;
    }

    fileListEl.innerHTML = '<li style="opacity:0.7">No programmatic listing available. Enable /questions/list, create /questions/index.json, or open ?file=your_file.json</li>';
  }

  // download helper
  function downloadIndexJson(list){
    const blob = new Blob([JSON.stringify(list, null, 2)], {type: 'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'index.json';
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=> URL.revokeObjectURL(a.href), 2000);
  }
  downloadIndexBtn.addEventListener('click', ()=> downloadIndexJson(state.files.length ? state.files : EMBEDDED_FILES));
  useEmbeddedBtn.addEventListener('click', ()=> { state.files = EMBEDDED_FILES.slice(); setLoadingFiles(state.files); });

  // select file (improved error messages)
  async function selectFile(filename, liEl){
    Array.from(fileListEl.children).forEach(ch=>ch.classList.remove('active'));
    if(liEl) liEl.classList.add('active');

    try{
      const res = await fetch('/questions/'+filename, {cache: 'no-store'});
      if(!res.ok){
        throw new Error(`Server responded ${res.status} for /questions/${filename}`);
      }
      const ct = (res.headers.get('content-type')||'').toLowerCase();
      const bodyText = await res.text();
      // Try to parse JSON safely
      let data;
      try {
        data = JSON.parse(bodyText);
      } catch(parseErr) {
        // helpful error when JSON invalid / server returned HTML or text
        throw new Error(`Failed to parse JSON for /questions/${filename}. Server returned content-type: ${ct || 'unknown'}. Response preview: ${bodyText.slice(0,400)}`);
      }

      let questions = Array.isArray(data) ? data : (data.questions || []);
      if(!questions || questions.length===0){
        alert('No questions found in '+filename);
        return;
      }
      state.questions = questions;
      state.current = 0;
      state.revealed = false;
      state.filename = filename;
      fileTitle.textContent = filename;
      emptyEl.style.display = 'none';
      quizArea.style.display = 'block';
      renderQuestion();
    }catch(err){
      // show a helpful modal-like alert with suggestions
      alert('Error loading file: ' + err.message + '\\nTip: verify the file exists at /questions/' + filename + ' and that it is valid JSON.');
    }
  }

  // render a question (robust UID here)
  function renderQuestion(){
    const q = state.questions[state.current];
    qTitle.textContent = `Q${state.current+1}: ${q.id ? '(id '+q.id+')' : ''}`;
    qText.textContent = q.question || 'Question text missing';

    const isMultiple = Array.isArray(q.correct);
    optionsEl.innerHTML = '';

    // robust unique name per question using crypto or fallback
    const uid = uniqueId();
    const name = 'opt_' + uid + '_' + state.current;

    (q.options || []).forEach((opt, idx)=>{
      const optEl = document.createElement('label');
      optEl.className = 'option';
      optEl.dataset.idx = idx;

      const input = document.createElement('input');
      input.type = isMultiple ? 'checkbox' : 'radio';
      input.name = name;
      input.value = idx;

      const txt = document.createElement('span');
      txt.textContent = opt;

      optEl.appendChild(input);
      optEl.appendChild(txt);
      optionsEl.appendChild(optEl);
    });

    qProgress.textContent = `${state.current+1} / ${state.questions.length}`;
    explainEl.style.display = 'none';
    explainEl.innerHTML = '';
    prevBtn.disabled = state.current === 0;
    nextBtn.disabled = state.current === state.questions.length-1;
    state.revealed = false;
    showAnsBtn.disabled = false;
  }

  // reveal answer
  function revealAnswer(){
    const q = state.questions[state.current];
    const isMultiple = Array.isArray(q.correct);
    const correctIdxs = isMultiple ? q.correct : [q.correct];

    Array.from(optionsEl.children).forEach(label=>{
      const idx = Number(label.dataset.idx);
      const input = label.querySelector('input');
      label.classList.remove('correct','wrong');
      if(correctIdxs.includes(idx)){
        label.classList.add('correct');
      } else if(input.checked){
        label.classList.add('wrong');
      }
    });

    explainEl.style.display = 'block';
    const explanation = q.explanation || 'No explanation provided.';
    const selected = Array.from(optionsEl.querySelectorAll('input'))
      .map((inp,i)=> inp.checked ? i : -1).filter(i=>i>=0);

    let status = '';
    if(selected.length===0) status = '<div style="margin-bottom:6px;color:#555">You did not select an answer.</div>';
    else {
      const selSet = new Set(selected);
      const corrSet = new Set(correctIdxs);
      const equal = selSet.size===corrSet.size && [...selSet].every(x => corrSet.has(x));
      status = equal ? '<div style="margin-bottom:6px;color:green;font-weight:600">Your selection is CORRECT</div>' : '<div style="margin-bottom:6px;color:#b33;font-weight:600">Your selection is INCORRECT</div>';
    }

    explainEl.innerHTML = status + '<div><strong>Answer:</strong> ' + correctIdxs.map(i=> q.options[i]).join(', ') + '</div>'
      + '<div style="margin-top:8px"><strong>Explanation:</strong><div style="margin-top:6px">'+explanation+'</div></div>';

    state.revealed = true;
    showAnsBtn.disabled = true;
  }

  // nav handlers
  prevBtn.addEventListener('click', ()=>{ if(state.current>0){ state.current--; renderQuestion(); }});
  nextBtn.addEventListener('click', ()=>{ if(state.current < state.questions.length-1){ state.current++; renderQuestion(); }});
  showAnsBtn.addEventListener('click', ()=> revealAnswer());
  restartBtn.addEventListener('click', ()=> { if(state.filename) selectFile(state.filename); });

  // start
  await initFileList();

  const params = new URLSearchParams(location.search);
  if(params.has('file')){
    const f = params.get('file');
    setTimeout(()=> selectFile(f), 300);
  }

})();
</script>
</body>
</html>
